apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: sword
spec:
  # kro uses this simple schema to create your CRD schema and apply it
  # The schema defines what users can provide when they instantiate the RGD (create an instance).
  schema:
    apiVersion: v1alpha1
    kind: Sword
    spec:
      # Spec fields that users can provide.
      name: string
      imageTag: string

  # Define the resources this API will manage.
  resources:
    - id: rollout
      template:
        apiVersion: argoproj.io/v1alpha1
        kind: Rollout
        metadata:
          name: ${schema.spec.name}
          namespace: anvil
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
        spec:
          replicas: 5
          strategy:
            canary:
              # I dont like that these are hardcoded to match the service names
              # but kro complains about a circular dependency if the rollout references
              # the service and the service references the rollout
              canaryService: ${schema.spec.name}-canary
              stableService: ${schema.spec.name}-stable
              trafficRouting:
                istio:
                  virtualService:
                    name: ${virtualService.metadata.name}
              steps:
                - setWeight: 50
                - pause: {duration: 5m}
                - setWeight: 100
          selector:
            matchLabels:
              app: ${schema.spec.name}
          template:
            metadata:
              labels:
                app: ${schema.spec.name}
            spec:
              containers:
                - name: anvil-server
                  image: anvil-server:${schema.spec.imageTag}
                  ports:
                    - containerPort: 8000

    - id: serviceStable
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${schema.spec.name}-stable
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
        spec:
          # selector: ${deployment.spec.selector.matchLabels} # Use the rollout selector
          selector: ${rollout.spec.selector.matchLabels} # Use the rollout selector
          ports:
            - protocol: TCP
              port: 80
              targetPort: 80

    - id: serviceCanary
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${schema.spec.name}-canary
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
        spec:
          selector: ${rollout.spec.selector.matchLabels} # Use the rollout selector
          ports:
            - protocol: TCP
              port: 80
              targetPort: 80

    - id: virtualService
      template:
        apiVersion: networking.istio.io/v1alpha3
        kind: VirtualService
        metadata:
          name: ${schema.spec.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
        spec:
          gateways:
            - anvil-gateway
          hosts:
            - ${schema.spec.name}.anvil.svc.cluster.local
          http:
            - name: primary
              route:
                - destination:
                    host: ${schema.spec.name}-stable
                  weight: 100
                - destination:
                    host: ${schema.spec.name}-canary
                  weight: 0